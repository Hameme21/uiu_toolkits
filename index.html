<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UIU Student Dashboard | Spring 2026</title>
    <style>
        /* --- GLOBAL VARIABLES & THEME --- */
        :root {
            --uiu-orange: #F37021;
            --uiu-blue: #005696;
            
            /* Light Theme */
            --bg-body: #fdf8f5;
            --bg-container: #ffffff;
            --bg-input: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #ffdcb0;
            
            /* Primary Accents */
            --primary-color: #F37021; 
            --secondary-color: #005696;
            --table-header-bg: #F37021;
            --table-header-text: #ffffff;
            
            /* Alert Colors */
            --clash-bg: #ffebee;
            --clash-border: #d32f2f;
            --same-day-bg: #fff8e1;
            --same-day-border: #ffc107;
            --course-added-bg: #fff3e0;
            
            --shadow: 0 4px 15px rgba(243, 112, 33, 0.15);
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --warning-border: #ffeeba;
        }

        /* Dark Mode Override */
        body.dark-mode {
            --bg-body: #121212;
            --bg-container: #1e1e1e;
            --bg-input: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333333;
            
            --primary-color: #F37021;
            --secondary-color: #64b5f6;
            --table-header-bg: #d85a0e;
            
            --clash-bg: #3e1a1a;
            --same-day-bg: #3e3310;
            --same-day-border: #9c7b16;
            --course-added-bg: #2d2318;
            
            --shadow: 0 4px 15px rgba(0,0,0,0.5);
            --warning-bg: #332701;
            --warning-text: #ffc107;
            --warning-border: #664d03;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            transition: background 0.3s, color 0.3s;
        }

        /* --- NAVIGATION --- */
        nav {
            background-color: var(--bg-container);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--primary-color);
        }

        .logo {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .nav-btn.active, .nav-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        body.dark-mode .nav-btn {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        body.dark-mode .nav-btn.active, 
        body.dark-mode .nav-btn:hover {
            background: var(--primary-color);
            color: #121212;
        }

        /* --- LAYOUT --- */
        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tool-section {
            display: none;
            background: var(--bg-container);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s;
            border-top: 5px solid var(--primary-color);
        }
        .tool-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { color: var(--primary-color); margin-top: 0; text-align: center; }
        p.subtitle { color: var(--text-muted); text-align: center; margin-bottom: 20px; }

        /* --- ALERTS --- */
        .disclaimer-box {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            border: 1px solid var(--warning-border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .alert-box {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        #clash-alert { background-color: var(--clash-bg); color: #d32f2f; border: 1px solid var(--clash-border); }
        #sameday-alert { background-color: var(--same-day-bg); color: #c49000; border: 1px solid var(--same-day-border); }
        body.dark-mode #sameday-alert { color: #ffca28; }

        /* --- INPUTS & SEARCH --- */
        .search-box { position: relative; max-width: 600px; margin: 0 auto 20px auto; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-main);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(243, 112, 33, 0.2); }

        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-container);
            border: 1px solid var(--border-color);
            max-height: 250px; overflow-y: auto; z-index: 100;
            display: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:hover { background-color: var(--bg-body); }
        .suggestion-item strong { color: var(--primary-color); }
        .shortcut-badge { background: var(--border-color); font-size: 0.75em; padding: 2px 6px; border-radius: 4px; color: var(--text-muted); }

        /* --- EXAM TABLE --- */
        .routine-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .routine-table th, .routine-table td {
            border: 1px solid var(--border-color);
            padding: 10px; text-align: center; vertical-align: top;
        }
        .routine-table th { background-color: var(--table-header-bg); color: var(--table-header-text); }
        
        .added-course {
            background-color: var(--course-added-bg);
            border-left: 4px solid var(--primary-color);
            padding: 8px 25px 8px 8px; /* Extra right padding for X button */
            margin-top: 5px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: left;
            position: relative;
        }
        .added-course.clash { background-color: var(--clash-bg); border-left-color: var(--clash-border); color: #d32f2f; }
        .added-course.sameday { border-left-color: var(--same-day-border); background-color: var(--same-day-bg); }
        
        .remove-btn {
            position: absolute; top: 2px; right: 5px;
            cursor: pointer; color: var(--text-muted); font-size: 1.2em; font-weight: bold;
        }
        .remove-btn:hover { color: red; }

        /* --- CGPA STYLES --- */
        .section-box { border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section-title {
            color: var(--primary-color); font-weight: bold; display: block;
            border-left: 4px solid var(--primary-color); padding-left: 10px; margin-bottom: 15px;
        }
        .cgpa-table { width: 100%; margin-bottom: 15px; border-collapse: collapse; }
        .cgpa-table th { background-color: var(--primary-color); color: white; padding: 10px; text-align: left; }
        .cgpa-table td { padding: 10px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }

        .btn-action { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-add { background-color: var(--secondary-color); color: white; width: auto; padding: 8px 20px; }
        .btn-calc { background-color: var(--primary-color); color: white; font-size: 1.1em; }
        .btn-delete { background-color: #ff4d4d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }

        .result-box {
            background-color: var(--course-added-bg); border: 2px solid var(--primary-color);
            padding: 20px; border-radius: 8px; text-align: center; display: none; margin-top: 20px;
        }
        .gpa-value { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        
        /* Retake styles */
        .retake-controls { display: flex; align-items: center; gap: 8px; }
        .prev-grade-wrapper { display: none; margin-top: 5px; }
        .prev-grade-wrapper.active { display: block; animation: fadeIn 0.3s; }
        .prev-grade-label { font-size: 0.8em; color: var(--text-muted); display: block; margin-bottom: 2px; }
        .retake-checkbox { width: 18px; height: 18px; cursor: pointer; }

        @media (max-width: 600px) {
            nav { flex-direction: column; gap: 10px; }
            .routine-table th, .routine-table td { font-size: 0.8em; padding: 5px; }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo">üéì UIU Toolkit</div>
    <div class="nav-buttons">
        <button class="nav-btn active" onclick="switchTab('exam')" id="btn-exam">Exam Routine</button>
        <button class="nav-btn" onclick="switchTab('cgpa')" id="btn-cgpa">CGPA Calc</button>
        <button class="nav-btn" onclick="switchTab('calendar')" id="btn-calendar">Calendar</button>
        <button class="nav-btn" onclick="toggleTheme()" id="btn-theme">üåô</button>
    </div>
</nav>

<div class="container">

    <div id="exam-section" class="tool-section active">
        <h1>Exam Clash Solver</h1>
        <p class="subtitle">Spring 2026 | CSE Dept. | Updated with Official Routine</p>

        <div class="disclaimer-box">
            ‚ö†Ô∏è DISCLAIMER: Data sourced from the "Spring 2026 Exam Template". Always verify with your official UCAM routine for last-minute changes.
        </div>

        <div id="clash-alert" class="alert-box">‚ö†Ô∏è CRITICAL CLASH: You have 2 exams at the EXACT same time!</div>
        <div id="sameday-alert" class="alert-box">‚ö†Ô∏è PRESSURE WARNING: Multiple exams on the same day.</div>

        <div class="search-box">
            <input type="text" id="courseSearch" placeholder="Type Code (e.g. 3811), Name (Artificial Intelligence), or Shortcut (AI)..." oninput="filterCourses()">
            <div class="suggestions" id="suggestions"></div>
        </div>

        <table class="routine-table">
            <thead>
                <tr>
                    <th style="width:10%">Day</th>
                    <th style="width:30%">Slot T1<br><small>9:00 - 11:00 AM</small></th>
                    <th style="width:30%">Slot T2<br><small>11:30 - 1:30 PM</small></th>
                    <th style="width:30%">Slot T3<br><small>2:00 - 4:00 PM</small></th>
                </tr>
            </thead>
            <tbody id="routineBody"></tbody>
        </table>
    </div>

    <div id="cgpa-section" class="tool-section">
        <h1>CGPA Calculator</h1>
        <p class="subtitle">UIU Grading Scale with Retake Support</p>

        <div class="section-box">
            <span class="section-title">Previous Results (Optional)</span>
            <div style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Prev. CGPA</label><input type="number" id="prevCGPA" placeholder="e.g. 3.50" step="0.01"></div>
                <div style="flex:1"><label>Credits Earned</label><input type="number" id="prevCredits" placeholder="e.g. 60" step="1"></div>
            </div>
        </div>

        <div class="section-box">
            <span class="section-title">Current Trimester</span>
            <table class="cgpa-table" id="courseTable">
                <thead>
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 20%">Credits</th>
                        <th style="width: 25%">Expected Grade</th>
                        <th style="width: 40%">Type</th>
                        <th style="width: 10%">X</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button class="btn-action btn-add" onclick="addCourseRow()">+ Add Course</button>
        </div>

        <button class="btn-action btn-calc" onclick="calculateCGPA()">Calculate CGPA</button>

        <div id="resultBox" class="result-box">
            <div>Current GPA: <span class="gpa-value" id="currentGPA">0.00</span></div>
            <div>Total CGPA: <span class="gpa-value" id="totalCGPA">0.00</span></div>
            <p>Total Credits: <span id="totalCreditsDisplay">0</span></p>
        </div>
    </div>

    <div id="calendar-section" class="tool-section">
        <h1>Academic Calendar</h1>
        <p class="subtitle">Spring 2026 | Key Dates & Deadlines</p>

        <table class="routine-table">
            <thead>
                <tr>
                    <th style="width: 25%">Date</th>
                    <th style="width: 75%">Event Details</th>
                </tr>
            </thead>
            <tbody id="calendarBody">
                </tbody>
        </table>
    </div>

</div>

<script>
    // --- DATA: SPRING 2026 ROUTINE MAPPING (CORRECTED) ---
    const rawRoutine = [
        // DAY 1
        { day: 1, time: 1, codes: ["ENG 1011", "ENG 101"], name: "Intensive English I", keywords: ["eng 1", "english"] },
        { day: 1, time: 1, codes: ["CSE 4509", "CSI 309"], name: "Operating Systems Concepts", keywords: ["os", "operating"] },
        { day: 1, time: 1, codes: ["IPE 3401", "IPE 401"], name: "Industrial & Operational Management", keywords: ["ipe", "management"] },
        { day: 1, time: 1, codes: ["DS 4491"], name: "Data Science Elective", keywords: [] },
        { day: 1, time: 2, codes: ["ENG 1013", "ENG 103"], name: "Intensive English II", keywords: ["eng 2", "english"] },
        { day: 1, time: 2, codes: ["DS 3885"], name: "DS Elective", keywords: [] },
        { day: 1, time: 2, codes: ["CSE 4945"], name: "UI: Concepts and Design", keywords: ["ui", "design", "user interface"] },
        { day: 1, time: 3, codes: ["MATH 2183", "MATH 183"], name: "Calculus & Linear Algebra", keywords: ["linear", "math", "calculus"] },
        { day: 1, time: 3, codes: ["CSE 3313", "CSE 313"], name: "Computer Architecture", keywords: ["ca", "archi"] },
        { day: 1, time: 3, codes: ["SOC 2101", "SOC 101"], name: "Society, Env. & Engineering Ethics", keywords: ["soc", "ethics"] },
        { day: 1, time: 3, codes: ["CSE 4889", "CSE 489"], name: "Machine Learning", keywords: ["ml", "machine"] },

        // DAY 2
        { day: 2, time: 1, codes: ["CSE 4621", "CSI 421"], name: "Computer Graphics", keywords: ["cg", "graphics"] },
        { day: 2, time: 1, codes: ["CSE 3521", "CSI 221"], name: "Database Management Systems", keywords: ["dbms", "database"] },
        { day: 2, time: 2, codes: ["CSE 4325", "CSE 425"], name: "Microprocessors & Microcontrollers", keywords: ["micro", "mpi"] },
        { day: 2, time: 2, codes: ["MATH 1151", "MATH 151"], name: "Fundamental Calculus", keywords: ["calc 1", "calculus"] },
        { day: 2, time: 3, codes: ["ACT 2111", "ACT 111"], name: "Financial & Managerial Accounting", keywords: ["act", "accounting"] },
        { day: 2, time: 3, codes: ["MATH 2205", "STAT 205"], name: "Probability & Statistics", keywords: ["stat", "prob"] },

        // DAY 3
        { day: 3, time: 1, codes: ["CSE 3811", "CSI 341"], name: "Artificial Intelligence", keywords: ["ai", "artificial"] },
        { day: 3, time: 1, codes: ["CSE 4451"], name: "Human Computer Interaction", keywords: ["hci"] },
        { day: 3, time: 2, codes: ["CSE 2213", "CSI 219"], name: "Discrete Mathematics", keywords: ["dm", "discrete"] },
        { day: 3, time: 2, codes: ["PMG 4101", "CSE 469"], name: "Project Management", keywords: ["pmg", "project"] },
        { day: 3, time: 2, codes: ["TEC 2499"], name: "Technology Entrepreneurship", keywords: ["entrepreneurship"] },
        { day: 3, time: 3, codes: ["CSE 1325", "CSE 225"], name: "Digital Logic Design", keywords: ["dld", "logic"] },
        { day: 3, time: 3, codes: ["CSE 4587", "CSE 487"], name: "Cloud Computing", keywords: ["cloud"] },
        { day: 3, time: 3, codes: ["BIO 3105", "BIO 101"], name: "Biology for Engineers", keywords: ["bio", "biology"] },
        { day: 3, time: 3, codes: ["CSE 4777"], name: "Network Security", keywords: ["security", "netsec"] },

        // DAY 4
        { day: 4, time: 1, codes: ["CSE 4611", "CSI 411"], name: "Compiler Design", keywords: ["compiler", "cd"] },
        { day: 4, time: 1, codes: ["CSE 4883", "CSI 483"], name: "Digital Image Processing", keywords: ["dip", "image"] },
        { day: 4, time: 2, codes: ["CSE 1111", "CSI 121"], name: "Structured Programming Language", keywords: ["spl", "c programming"] },
        { day: 4, time: 2, codes: ["CSE 2215", "CSI 217"], name: "Data Structure & Algorithms I", keywords: ["dsa 1", "dsa"] },
        { day: 4, time: 2, codes: ["DS 1501"], name: "Programming for Data Science", keywords: ["pds"] },
        { day: 4, time: 2, codes: ["CSE 4435"], name: "Software Architecture", keywords: ["sa", "architecture"] },
        { day: 4, time: 2, codes: ["DS 2251"], name: "Data Structures & Algorithms II (DS)", keywords: [] },
        { day: 4, time: 3, codes: ["CSE 3711", "CSE 323"], name: "Computer Networks", keywords: ["network", "net", "cn"] },
        { day: 4, time: 3, codes: ["DS 4523"], name: "DS Elective", keywords: [] },
        { day: 4, time: 3, codes: ["CSE 4893", "CSE 493"], name: "Introduction to Bioinformatics", keywords: ["bioinformatics"] },
        { day: 4, time: 3, codes: ["DS 3101"], name: "Data Science Core", keywords: [] },

        // DAY 5
        { day: 5, time: 1, codes: ["MATH 2201", "MATH 201"], name: "Coord. Geometry & Vector Analysis", keywords: ["math 2", "vector"] },
        { day: 5, time: 1, codes: ["CSE 3411", "CSI 311"], name: "System Analysis and Design", keywords: ["sad", "system analysis"] },
        { day: 5, time: 1, codes: ["EEE 4261"], name: "Green Computing", keywords: ["green", "energy"] },
        { day: 5, time: 2, codes: ["CSE 2217", "CSI 227"], name: "Data Structure & Algorithms II", keywords: ["dsa 2", "algo"] },
        { day: 5, time: 2, codes: ["DS 1101"], name: "Fund. of Data Science", keywords: ["fds"] },
        { day: 5, time: 3, codes: ["CSE 3421", "CSI 321"], name: "Software Engineering", keywords: ["se", "software"] },
        
        // DAY 6
        { day: 6, time: 1, codes: ["BDS 1201"], name: "History of the Emergence of BD", keywords: ["bds", "history"] },
        { day: 6, time: 1, codes: ["ECO 4101", "ECO 213"], name: "Economics", keywords: ["eco", "economics"] },
        { day: 6, time: 1, codes: ["DS 3521"], name: "Database Systems (DS)", keywords: [] },
        { day: 6, time: 2, codes: ["CSE 1115", "CSI 211"], name: "Object Oriented Programming", keywords: ["oop", "java"] },
        { day: 6, time: 2, codes: ["CSE 4783"], name: "Cryptography", keywords: ["crypto", "security"] },
        { day: 6, time: 2, codes: ["DS 4891"], name: "DS Elective", keywords: [] },
        { day: 6, time: 3, codes: ["EEE 2113", "CSE 113"], name: "Electrical Circuits", keywords: ["circuit", "electrical"] },
        { day: 6, time: 3, codes: ["EEE 2123", "CSE 123"], name: "Electronics", keywords: ["electronics"] },
        { day: 6, time: 3, codes: ["CSE 4531"], name: "Computer Security", keywords: ["security", "cyber"] },
        { day: 6, time: 3, codes: ["CSE 4181", "CSE 481"], name: "Mobile App Development", keywords: ["mad", "android"] },

        // DAY 7
        { day: 7, time: 1, codes: ["CSE 4891", "CSE 491"], name: "Data Mining", keywords: ["mining", "dm"] },
        { day: 7, time: 1, codes: ["CSE 4165", "CSE 465"], name: "Web Programming", keywords: ["web", "internet"] },
        { day: 7, time: 2, codes: ["CSE 2233", "CSI 233"], name: "Theory of Computation", keywords: ["toc", "theory"] },
        { day: 7, time: 3, codes: ["CSE 4495", "CSE 495"], name: "Software Testing & QA", keywords: ["sqa", "testing"] },
        { day: 7, time: 3, codes: ["PHY 2105", "PHY 105"], name: "Physics", keywords: ["phy", "physics"] },
        { day: 7, time: 3, codes: ["DS 3881"], name: "DS Elective", keywords: [] }
    ];

    // --- ACADEMIC CALENDAR DATA ---
    const academicCalendar = [
        { date: "Feb 23, 2026", event: "Last day of Course Advising & Registration without Fine" },
        { date: "Mar 2, 2026", event: "Last day to drop course(s) with 100% adjustable refund" },
        { date: "Mar 9, 2026", event: "Last day to apply for Grade Change (Fall 2025)" },
        { date: "Mar 10, 2026", event: "Last day to drop course(s) with 50% adjustable refund" },
        { date: "Mar 15, 2026", event: "Last day of Course Advising & Registration with Fine of Tk. 500" },
        { date: "Mar 27, 2026", event: "Holiday: Shab-e-Qadr / Eid-ul-Fitr / Independence Day", highlight: true },
        { date: "Apr 13, 2026", event: "Make-up class: Regular Tuesday Classes" },
        { date: "Apr 18 - 24, 2026", event: "Mid-Term Exams", highlight: true },
        { date: "Apr 25, 2026", event: "Regular Tuesday/Wednesday Classes" },
        { date: "May 12, 2026", event: "Last date of 2nd installment" },
        { date: "May 20, 2026", event: "Holiday: Eid-ul-Adha", highlight: true },
        { date: "Jun 14, 2026", event: "Last date of 3rd installment" },
        { date: "Jun 20, 2026", event: "Classes suspended for Exam preparation" },
        { date: "Jun 21, 2026", event: "Final Exams Begin", highlight: true },
        { date: "Jul 7, 2026", event: "Summer 2026 Trimester Begins" }
    ];

    // --- APP LOGIC ---
    let myCourses = [];

    // Tab Switcher
    function switchTab(tab) {
        document.querySelectorAll('.tool-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tab + '-section').classList.add('active');
        document.getElementById('btn-' + tab).classList.add('active');
    }

    // Theme Toggle
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const btn = document.getElementById('btn-theme');
        if (document.body.classList.contains('dark-mode')) {
            btn.innerHTML = '‚òÄÔ∏è';
            localStorage.setItem('theme', 'dark');
        } else {
            btn.innerHTML = 'üåô';
            localStorage.setItem('theme', 'light');
        }
    }
    if (localStorage.getItem('theme') === 'dark') toggleTheme();

    // --- EXAM LOGIC ---
    function initGrid() {
        const tbody = document.getElementById('routineBody');
        tbody.innerHTML = '';
        for (let i = 1; i <= 7; i++) {
            tbody.innerHTML += `<tr><td class="day-header">Day ${i}</td><td id="d${i}-t1"></td><td id="d${i}-t2"></td><td id="d${i}-t3"></td></tr>`;
        }
    }

    function filterCourses() {
        const input = document.getElementById('courseSearch').value.toLowerCase();
        const suggestionBox = document.getElementById('suggestions');
        suggestionBox.innerHTML = '';
        if (input.length < 2) { suggestionBox.style.display = 'none'; return; }

        const matches = [];
        rawRoutine.forEach(item => {
            const nameMatch = item.name.toLowerCase().includes(input);
            const codeMatch = item.codes.some(c => c.toLowerCase().includes(input));
            const keywordMatch = item.keywords.some(k => k.toLowerCase().includes(input));
            if (nameMatch || codeMatch || keywordMatch) {
                matches.push({ displayName: `${item.name} (${item.codes[0]})`, shortcutMatch: keywordMatch, data: item });
            }
        });

        if (matches.length > 0) {
            suggestionBox.style.display = 'block';
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>${match.displayName}</strong>${match.shortcutMatch ? '<span class="shortcut-badge">Shortcut</span>' : ''}`;
                div.onclick = () => addCourse(match.data);
                suggestionBox.appendChild(div);
            });
        } else { suggestionBox.style.display = 'none'; }
    }

    function addCourse(courseData) {
        if (myCourses.some(c => c.name === courseData.name && c.codes[0] === courseData.codes[0])) {
            alert("Course already added!"); return;
        }
        myCourses.push(courseData);
        document.getElementById('courseSearch').value = '';
        document.getElementById('suggestions').style.display = 'none';
        renderSchedule();
    }

    function renderSchedule() {
        for (let d = 1; d <= 7; d++) {
            for (let t = 1; t <= 3; t++) { document.getElementById(`d${d}-t${t}`).innerHTML = ''; }
        }
        
        let timeClash = false;
        let sameDayPressure = false;
        const dayCounts = {};
        const slotMap = {};
        
        myCourses.forEach(course => {
            const key = `d${course.day}-t${course.time}`;
            if (!slotMap[key]) slotMap[key] = [];
            slotMap[key].push(course);
            
            if (!dayCounts[course.day]) dayCounts[course.day] = 0;
            dayCounts[course.day]++;
        });

        for (const [key, coursesInSlot] of Object.entries(slotMap)) {
            const cell = document.getElementById(key);
            const isClash = coursesInSlot.length > 1;
            if (isClash) timeClash = true;

            coursesInSlot.forEach(course => {
                const div = document.createElement('div');
                const isSameDay = dayCounts[course.day] > 1;
                let className = 'added-course';
                if (isClash) className += ' clash';
                else if (isSameDay) { className += ' sameday'; sameDayPressure = true; }

                div.className = className;
                div.innerHTML = `<span class="remove-btn" onclick="removeCourse('${course.codes[0]}')">&times;</span>
                                 <strong>${course.name}</strong><br><small>${course.codes.join('/')}</small>`;
                cell.appendChild(div);
            });
        }
        
        document.getElementById('clash-alert').style.display = timeClash ? 'block' : 'none';
        document.getElementById('sameday-alert').style.display = (sameDayPressure && !timeClash) ? 'block' : 'none';
    }

    function removeCourse(code) {
        myCourses = myCourses.filter(c => c.codes[0] !== code);
        renderSchedule();
    }

    // --- CGPA LOGIC WITH RETAKE ---
    const gradePoints = { "A":4.00, "A-":3.67, "B+":3.33, "B":3.00, "B-":2.67, "C+":2.33, "C":2.00, "C-":1.67, "D+":1.33, "D":1.00, "F":0.00 };
    
    function addCourseRow() {
        const tbody = document.querySelector("#courseTable tbody");
        const row = document.createElement("tr");
        let opts = "";
        for (let g in gradePoints) opts += `<option value="${gradePoints[g]}">${g}</option>`;
        
        // Prev grade options (including F)
        let prevOpts = "";
        for (let g in gradePoints) prevOpts += `<option value="${gradePoints[g]}">${g}</option>`;

        row.innerHTML = `
            <td>${tbody.rows.length + 1}</td>
            <td><input type="number" class="c-credit" value="3" step="0.5"></td>
            <td><select class="c-grade-new">${opts}</select></td>
            <td>
                <div class="retake-controls">
                    <input type="checkbox" class="retake-checkbox" onchange="toggleRetake(this)">
                    <span>Retake?</span>
                </div>
                <div class="prev-grade-wrapper">
                    <span class="prev-grade-label">Old Grade:</span>
                    <select class="c-grade-old">${prevOpts}</select>
                </div>
            </td>
            <td><button class="btn-delete" onclick="this.closest('tr').remove(); updateRows()">‚úï</button></td>`;
        tbody.appendChild(row);
    }

    function toggleRetake(checkbox) {
        const wrapper = checkbox.closest('td').querySelector('.prev-grade-wrapper');
        if(checkbox.checked) {
            wrapper.classList.add('active');
        } else {
            wrapper.classList.remove('active');
        }
    }
    
    function updateRows() {
        document.querySelectorAll("#courseTable tbody tr").forEach((row, i) => row.cells[0].innerText = i + 1);
    }

    function calculateCGPA() {
        // 1. Get Previous Data
        let prevCGPA = parseFloat(document.getElementById("prevCGPA").value) || 0;
        let prevCredits = parseFloat(document.getElementById("prevCredits").value) || 0;
        
        let totalPoints = prevCGPA * prevCredits;
        let totalCredits = prevCredits;
        
        let currentPoints = 0;
        let currentCredits = 0;

        // 2. Loop through rows
        document.querySelectorAll("#courseTable tbody tr").forEach(row => {
            const crd = parseFloat(row.querySelector(".c-credit").value) || 0;
            const newGrade = parseFloat(row.querySelector(".c-grade-new").value);
            const isRetake = row.querySelector(".retake-checkbox").checked;
            
            if (crd > 0) {
                if (isRetake) {
                    const oldGrade = parseFloat(row.querySelector(".c-grade-old").value);
                    
                    totalPoints = totalPoints - (oldGrade * crd) + (newGrade * crd);
                    
                    if (oldGrade === 0.00) {
                        // Previous F: We gain new credits now
                        totalCredits += crd;
                    }
                    
                } else {
                    // Fresh Course
                    totalPoints += (crd * newGrade);
                    totalCredits += crd;
                }
                
                // Track current stats separately just for display
                currentPoints += (crd * newGrade);
                currentCredits += crd; 
            }
        });

        // 3. Final Calculations
        const finalCGPA = totalCredits ? (totalPoints / totalCredits).toFixed(2) : "0.00";
        // Note: Current GPA is just average of this semester's inputs
        const curGPA = currentCredits ? (currentPoints / currentCredits).toFixed(2) : "0.00";

        document.getElementById("currentGPA").innerText = curGPA;
        document.getElementById("totalCGPA").innerText = finalCGPA;
        document.getElementById("totalCreditsDisplay").innerText = totalCredits;
        document.getElementById("resultBox").style.display = "block";
    }

    // --- CALENDAR LOGIC ---
    function renderCalendar() {
        const tbody = document.getElementById('calendarBody');
        tbody.innerHTML = '';
        academicCalendar.forEach(item => {
            const rowStyle = item.highlight ? 'style="background-color: var(--course-added-bg); font-weight: bold;"' : '';
            tbody.innerHTML += `
                <tr ${rowStyle}>
                    <td><strong>${item.date}</strong></td>
                    <td style="text-align: left; padding-left: 15px;">${item.event}</td>
                </tr>
            `;
        });
    }

    // Init
    window.onload = function() {
        initGrid();
        addCourseRow(); addCourseRow(); addCourseRow();
        renderCalendar();
        document.addEventListener('click', e => {
            if (!e.target.closest('.search-box')) document.getElementById('suggestions').style.display = 'none';
        });
    };
</script>

</body>
</html>
